<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>nmsg: nmsg documentation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="nmsg.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">nmsg<span id="projectnumber">&#160;1.1.2</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">nmsg documentation </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="intro"></a>
Introduction</h1>
<p>The NMSG format is an efficient encoding of typed, structured data into payloads which are packed into containers which can be transmitted over the network or stored to disk. <code>libnmsg</code> is the reference implementation of this format and provides an extensible interface for creating and parsing messages in NMSG format. The NMSG format relies on Google <a href="http://code.google.com/p/protobuf/">Protocol Buffers</a> to encode the payload header. Individual NMSG payloads are distinguished by assigned vendor ID and message type values and <code>libnmsg</code> provides a modular interface for registering handlers for specific message types. <code>libnmsg</code> makes it easy to build new message types using a <a href="http://code.google.com/p/protobuf-c/">Protocol Buffers</a> compiler.</p>
<dl class="section see"><dt>See also</dt><dd><a href="http://code.google.com/p/protobuf/">http://code.google.com/p/protobuf/</a> </dd>
<dd>
<a href="http://code.google.com/p/protobuf-c/">http://code.google.com/p/protobuf-c/</a></dd></dl>
<hr  />
<h1><a class="anchor" id="libnmsg"></a>
libnmsg</h1>
<p><code>libnmsg</code> provides a reference C implementation of an NMSG parser and generator. It contains core functions for reading and writing NMSG units and can be extended at runtime by plugin modules implementing new message types.</p>
<h2><a class="anchor" id="core"></a>
Core I/O functions</h2>
<div class="subsection"></div><div class="subsection"><a class="el" href="input_8h.html" title="Convert input streams to nmsg format.">input.h</a> and <a class="el" href="output_8h.html" title="Write nmsg containers to output streams.">output.h</a> provide the single-threaded input and output interfaces. <a class="el" href="io_8h.html" title="Multi-threaded nmsg I/O processing.">io.h</a> provides a multi-threaded interface for multiplexing data between inputs and outputs. <a class="el" href="message_8h.html" title="Create, load, inspect, and manipulate message objects. Message objects are proxy objects that bind to...">message.h</a> provides an interface for creating and inspecting message payloads.</div><div class="subsection"></div><h2><a class="anchor" id="nmsg_msg"></a>
nmsg_msg message module interface</h2>
<div class="subsection"></div><div class="subsection">The <b>nmsg_msg</b> message module interface is implemented by <a class="el" href="msgmod_8h.html" title="Message modules.">msgmod.h</a>. Plugins in external shared objects provide an <code>nmsg_msgmod_t</code> structure in order to implement new message types.</div><div class="subsection"></div><h2><a class="anchor" id="aux"></a>
Auxiliary functions</h2>
<div class="subsection"></div><div class="subsection"><ul>
<li>
<a class="el" href="alias_8h.html" title="Nmsg payload operator and group aliasing.">alias.h</a> </li>
<li>
<a class="el" href="asprintf_8h.html" title="Asprintf utility functions.">asprintf.h</a> </li>
<li>
<a class="el" href="chalias_8h.html" title="Nmsg channel aliases.">chalias.h</a> </li>
<li>
<a class="el" href="ipdg_8h.html" title="IP datagram parsing functions.">ipdg.h</a> </li>
<li>
<a class="el" href="pcap__input_8h.html" title="Reassembled IP datagram interface to libpcap.">pcap_input.h</a> </li>
<li>
<a class="el" href="rate_8h.html" title="Rate-limiting.">rate.h</a> </li>
<li>
<a class="el" href="strbuf_8h.html" title="String buffers.">strbuf.h</a> </li>
<li>
<a class="el" href="timespec_8h.html" title="Sleeping and getting the current time.">timespec.h</a> </li>
<li>
<a class="el" href="zbuf_8h.html" title="Compressed buffers.">zbuf.h</a> </li>
</ul>
</div><div class="subsection"></div><hr  />
<h1><a class="anchor" id="wire_format"></a>
Wire format</h1>
<p>An NMSG unit consists of a small fixed-length header which precedes a variable length part that may contain one or more payloads or, if a single payload is too large, the variable length part may contain a single message fragment.</p>
<p>NMSG is designed for transport over UDP sockets or storage in on-disk files. Individual UDP datagrams may transport only a single NMSG unit, while the file format is simply a series of NMSG units concatenated together. The variable length part of an NMSG unit transported over UDP is usually much smaller than those stored on disk (<a class="el" href="constants_8h.html#ab760a31c14617ffc793a16b90553a8e8" title="Maximum number of octets that an nmsg wbuf can hold.">NMSG_WBUFSZ_MAX</a> versus <a class="el" href="constants_8h.html#a138ceccb7260187377cf1df5f7800f62" title="Number of octets that an nmsg wbuf destined for transport over a jumbo frame Ethernet should hold.">NMSG_WBUFSZ_JUMBO</a> or <a class="el" href="constants_8h.html#a94666728afb6a43dccdfc0ea995bc61e" title="Number of octets that an nmsg wbuf destined for transport over an Ethernet should hold.">NMSG_WBUFSZ_ETHER</a>). NMSG units stored on disk also do not contain message fragments.</p>
<p>The fixed-length NMSG header is ten octets long and consists of a magic value, a bit field of flags, a protocol version number, and the length of the variable length data part.</p>
<p>The variable length data part is interpreted as a Protocol Buffer message.</p>
<table class="doxtable">
<tr>
<th>Octet 0-3 </th><th>Octet 4 </th><th>Octet 5 </th><th>Octet 6-9 </th><th><p class="starttd">Remainder </p>
<p class="endtd"></p>
</th></tr>
<tr>
<td><center>Magic</center> </td><td><center>Flags</center> </td><td><center>Protocol Version</center> </td><td><center>Length</center> </td><td><center>Data</center> <p class="endtd"></p>
</td></tr>
</table>
<h2><a class="anchor" id="magic"></a>
Magic value</h2>
<div class="subsection"></div><div class="subsection">The magic value (<a class="el" href="constants_8h.html#a44de96b0ac164c61be1bd2e48cf8b0ad" title="Four-octet magic sequence seen at the beginning of a serialized NMSG.">NMSG_MAGIC</a>) is always the four octet sequence 'N', 'M', 'S', 'G'.</div><div class="subsection"></div><h2><a class="anchor" id="flags"></a>
Flags</h2>
<div class="subsection"></div><div class="subsection">This is a bit field of flags. Currently two values are defined. <a class="el" href="constants_8h.html#a9f62bed71033149fb1edd3d3c180e8f6" title="NMSG container is zlib compressed.">NMSG_FLAG_ZLIB</a> indicates that the data content has been compressed. <a class="el" href="constants_8h.html#a4e753c406bf79de5abaa093c6e2e6e24" title="NMSG container is fragmented.">NMSG_FLAG_FRAGMENT</a> indicates that the data content starts a special fragmentation header.</div><div class="subsection"></div><h3><a class="anchor" id="zlib"></a>
NMSG_FLAG_ZLIB</h3>
<div class="subsubsection"></div><div class="subsubsection">This flag indicates that zlib compression has been applied to the variable length part. If the <a class="el" href="constants_8h.html#a4e753c406bf79de5abaa093c6e2e6e24" title="NMSG container is fragmented.">NMSG_FLAG_FRAGMENT</a> flag is not also set, then the entire variable length part should be deflated with zlib and interpreted as an <b>NmsgPayload</b>.</div><div class="subsubsection"></div><h3><a class="anchor" id="frag"></a>
NMSG_FLAG_FRAGMENT</h3>
<div class="subsubsection"></div><div class="subsubsection">This flag indicates that the variable length part should be interpreted as an <b>NmsgFragment</b>. After reassembly, the data should be interpreted as an <b>NmsgPayload</b>. If the <a class="el" href="constants_8h.html#a9f62bed71033149fb1edd3d3c180e8f6" title="NMSG container is zlib compressed.">NMSG_FLAG_ZLIB</a> flag is also set, then the reassembled data should be deflated and then interpreted as an <b>NmsgPayload</b>.</div><div class="subsubsection">Note that when creating a compressed, fragmented NMSG unit, compression should be applied <em>before</em> fragmentation.</div><div class="subsubsection"></div><h2><a class="anchor" id="version"></a>
Protocol Version</h2>
<div class="subsection"></div><div class="subsection">This value (NMSG_PROTOCOL_VERSION) is currently 2.</div><div class="subsection"></div><h2><a class="anchor" id="length"></a>
Length</h2>
<div class="subsection"></div><div class="subsection">This value is an unsigned 32 bit integer in network byte order indicating the length in octets of the variable length data part.</div><div class="subsection"></div><h2><a class="anchor" id="data"></a>
Data</h2>
<div class="subsection"></div><div class="subsection">The variable length data part is encoded using <a href="http://code.google.com/apis/protocolbuffers/docs/encoding.html">Google Protocol Buffers</a>. The file <code>nmsg/nmsg.proto</code> in the source distribution describes the two message types <b>Nmsg</b> and <b>NmsgFragment</b> that can appear in NMSG units:</div><div class="subsection"><div class="fragment"><div class="line">syntax = &quot;proto2&quot;;</div>
<div class="line">package nmsg;</div>
<div class="line"> </div>
<div class="line">message Nmsg {</div>
<div class="line">    repeated NmsgPayload    payloads = 1;</div>
<div class="line">    repeated uint32         payload_crcs = 2;</div>
<div class="line">    optional uint32         sequence = 3;</div>
<div class="line">    optional uint64         sequence_id = 4;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">message NmsgFragment {</div>
<div class="line">    required uint32         id = 1;</div>
<div class="line">    required uint32         current = 2;</div>
<div class="line">    required uint32         last = 3;</div>
<div class="line">    required bytes          fragment = 4;</div>
<div class="line">    optional uint32         crc = 5;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">message NmsgPayload {</div>
<div class="line">    required uint32         vid = 1;</div>
<div class="line">    required uint32         msgtype = 2;</div>
<div class="line">    required int64          time_sec = 3;</div>
<div class="line">    required fixed32        time_nsec = 4;</div>
<div class="line">    optional bytes          payload = 5;</div>
<div class="line">    optional uint32         source = 7;</div>
<div class="line">    optional uint32         operator = 8;</div>
<div class="line">    optional uint32         group = 9;</div>
<div class="line">}</div>
</div><!-- fragment --></div><div class="subsection">If no flags are set, then the data part is an <b>Nmsg</b> protobuf message. If only the <a class="el" href="constants_8h.html#a9f62bed71033149fb1edd3d3c180e8f6" title="NMSG container is zlib compressed.">NMSG_FLAG_ZLIB</a> flag is set, then the data part is a zlib compressed <b>Nmsg</b> protobuf message. The <b>Nmsg</b> protobuf message is a container message for one or more <b>NmsgPayload</b> messages. If only the <a class="el" href="constants_8h.html#a4e753c406bf79de5abaa093c6e2e6e24" title="NMSG container is fragmented.">NMSG_FLAG_FRAGMENT</a> flag is set, then the data part is an <b>NmsgFragment</b> protobuf message.</div><div class="subsection"></div><h3><a class="anchor" id="nmsg"></a>
Nmsg and NmsgPayload protobuf messages</h3>
<div class="subsubsection"></div><div class="subsubsection"><b>Nmsg</b> messages contain one or more <b>NmsgPayload</b> messages.</div><div class="subsubsection">The <b>vid</b> field of <b>NmsgPayload</b> messages is the vendor ID. The currently defined vendor IDs are listed in <a class="el" href="vendors_8h.html" title="NMSG vendor ID values.">vendors.h</a> and assigned by Farsight. The <b>msgtype</b> field is a vendor-specific value and together the (<b>vid</b>, <b>msgtype</b>) tuple defines the type of the data contained in the <b>payload</b> field.</div><div class="subsubsection">The time that the data encapsulated in the <b>payload</b> field was generated is stored in the <b>time_sec</b> and <b>time_nsec</b> fields. The number of nanoseconds since the Unix epoch is split across the two fields, with the integer number of seconds stored in the <b>time_sec</b> field and the nanoseconds part stored in the <b>time_nsec</b> field.</div><div class="subsubsection">The <b>source</b>, <b>operator</b>, and <b>group</b> fields are optional fields that can be used by cooperating senders and receivers to classify the payload.</div><div class="subsubsection"></div><h3><a class="anchor" id="nmsgfragment"></a>
NmsgFragment protobuf messages</h3>
<div class="subsubsection"></div><div class="subsubsection"><b>NmsgFragment</b> messages are used to encapsulate fragments of an <b>Nmsg</b> message if the serialized message is too large for the underlying transport. This enables NMSG payloads to avoid the size restrictions of UDP/IP transport.</div><div class="subsubsection">If a serialized <b>Nmsg</b> message is too large for the underlying transport, it is split into fragments which are carried in the <b>fragment</b> field of a sequence of <b>NmsgFragment</b> messages. A random value is selected for the <b>id</b> field of these fragments. The 0-indexed <b>current</b> field indicates the ordering of the fragments, and the <b>last</b> field indicates the total number of fragments. Once a receiver has received all the fragments for a given fragment <b>id</b>, the fragmented payload should be extracted from the <b>payload</b> field of each fragment and concatenated into a buffer.</div><div class="subsubsection">If the sender performed compression of the <b>Nmsg</b> message before fragmentation, then all fragments should have the <a class="el" href="constants_8h.html#a9f62bed71033149fb1edd3d3c180e8f6" title="NMSG container is zlib compressed.">NMSG_FLAG_ZLIB</a> field set and the receiver must perform decompression of the reassembled buffer. The result of decompression should be interpreted as an <b>Nmsg</b> message.</div><div class="subsubsection">If the sender did not perform compression before fragmentation, then the buffer should be directly interpreted as an <b>Nmsg</b> message.</div><div class="subsubsection"></div> </div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
